# 改善点まとめ（V2）

**サンプルスプレッドシート**: https://docs.google.com/spreadsheets/d/1zS9AWg4DEpIIx0w4QaDm8RBFrLdmnNCjl6YFUd7QXSM/edit?usp=sharing

---

## V2で追加された新機能

### カスタムメニュー

スプレッドシートを開くと「ドライブ監視」メニューが表示され、プログラミング知識がなくても操作できます。

| メニュー項目 | 機能 |
|-------------|------|
| 初期セットアップ | mainシート、ヘッダー、チェックボックスを自動作成 |
| 今すぐチェック実行 | 手動でフォルダをチェック |
| 自動実行設定 | 1時間/6時間/毎日の定期実行を設定 |
| サンプル行を追加 | 入力例を追加 |
| 使い方を表示 | ヘルプを表示 |

### 初期セットアップの自動化

「初期セットアップ」を実行すると、以下が自動で設定されます：
- mainシートの作成
- ヘッダー行の追加（青い背景、白い文字）
- 列幅の調整
- A列にチェックボックス
- 1行目の固定

---

## 📝 コメントで報告された不具合と修正内容

### 1. 共有ドライブ対応の問題

**報告内容：**
- マイドライブ内のフォルダだと動作するが、共有ドライブ内のフォルダだと「フォルダIDが無効です」というエラーが出る

**原因：**
- `DriveApp.getFolderById()`は共有ドライブ（Google Workspaceの共有ドライブ）のフォルダを直接取得できない場合がある
- Drive APIを使用する必要がある

**修正内容：**
- `getFolderById()`関数を改善し、DriveAppで取得できない場合はDrive APIを使用するように変更
- `outputFolderContentsWithDriveAPI()`関数を追加し、Drive APIを使用したファイル一覧取得を実装
- `outputFolderInfoWithDriveAPI()`関数を追加し、Drive APIを使用した再帰的なフォルダ探索を実装

**使用方法：**
- Drive APIを有効化する必要があります（手順書参照）
- 共有ドライブのフォルダにアクセスする権限が必要です

---

### 2. URLとフォルダIDの扱いの問題

**報告内容：**
- B列にフォルダのURLを貼って実行しても「フォルダIDが無効です」と表示される
- URLではなくフォルダIDを直接貼り付けると動作する

**原因：**
- URLからフォルダIDを抽出する処理が不十分だった
- 複数のURLパターンに対応していなかった

**修正内容：**
- `extractFolderId()`関数を改善し、以下のパターンに対応：
  - 標準パターン: `https://drive.google.com/drive/folders/ID`
  - パラメータパターン: `https://drive.google.com/drive/?id=ID`
  - ハッシュパターン: `https://drive.google.com/drive/#folders/ID`
  - フォルダIDのみ: `ID`（直接入力）
- フォルダIDの形式（英数字とハイフン、アンダースコアのみ）を自動判定

**使用方法：**
- URLまたはフォルダIDのどちらでも入力可能になりました
- より柔軟な入力形式に対応しています

---

### 3. シートが作成されない問題

**報告内容：**
- 実行まではされるが、新しいシートが作成されない

**原因：**
- シート名に使用できない文字が含まれている場合の処理が不十分
- シート名の長さ制限（31文字）への対応が不十分
- 同名シートが存在する場合の処理が不十分

**修正内容：**
- `createSheet()`関数を改善：
  - シート名に使用できない文字（`/`, `\`, `?`, `*`, `[`, `]`, `:`）を自動的に`_`に置換
  - シート名が31文字を超える場合は自動的に切り詰め
  - 同名シートが存在する場合は自動的に番号を付加（例：`フォルダ名_1`）
- エラーハンドリングを強化し、シート作成失敗時のログ出力を追加

**使用方法：**
- 特別な設定は不要です
- プログラムが自動的に適切なシート名を生成します

---

### 4. シートが重複作成される問題（追加）

**報告内容：**
- フォルダ名に使えない文字があると、シートが毎回増えることがある
- 同名フォルダがある場合に意図しないシートが作られる

**原因：**
- フォルダ名とシート名の対応が固定されておらず、再実行時に別名と判定されることがある

**修正内容：**
- フォルダIDとシート名を紐付けて保存（Document Properties）
- シートのA1にフォルダIDをノートとして記録し、再実行時に正確に同じシートを特定

**使用方法：**
- 特別な設定は不要です
- 既に重複したシートがある場合は不要なシートを削除してください

---

## 🆕 その他の改善点

### 5. エラーハンドリングの強化

**改善内容：**
- 各処理でエラーが発生した場合でも、他のフォルダの処理を継続できるように改善
- エラーメッセージをスプレッドシートのG列に記録
- 詳細なログ出力を追加（Apps Scriptのログで確認可能）

**効果：**
- 一部のフォルダでエラーが発生しても、他のフォルダの監視は継続されます
- エラーの原因を特定しやすくなりました

---

### 6. パフォーマンス改善

**改善内容：**
- シートへの書き込みをバッチ処理に変更（1行ずつではなく、まとめて書き込み）
- ヘッダー行の自動検出機能を追加

**効果：**
- 大量のファイルがある場合でも処理速度が向上しました
- ヘッダー行の有無に関わらず動作します

---

### 7. オーナー情報の取得改善

**改善内容：**
- `getOwnerEmail()`関数を追加し、DriveAppで取得できない場合はDrive APIを使用
- エラーが発生しても処理を継続できるように改善

**効果：**
- 共有ドライブのフォルダでもオーナー情報を取得できるようになりました
- 取得できない場合でも「取得不可」と表示され、処理は継続されます

---

## 🔄 変更前後の比較

### 変更前の問題点

1. ❌ 共有ドライブのフォルダを監視できない
2. ❌ URLからフォルダIDを正しく抽出できない
3. ❌ シート名に問題がある場合、シートが作成されない
4. ❌ シートが重複作成される可能性がある
5. ❌ エラーが発生すると処理が停止する
6. ❌ パフォーマンスが悪い（大量のファイルがある場合）

### 変更後の改善点

1. ✅ 共有ドライブのフォルダも監視可能（Drive API使用）
2. ✅ 複数のURLパターンに対応、フォルダIDの直接入力も可能
3. ✅ シート名を自動的に適切な形式に変換
4. ✅ シート名の重複作成を防止（フォルダIDで紐付け）
5. ✅ エラーが発生しても他の処理を継続
6. ✅ バッチ処理によりパフォーマンス向上

---

## 📋 移行手順

既存のスプレッドシートを使用している場合：

1. **既存のコードをバックアップ**
   - Apps Scriptエディタで既存のコードをコピーして保存

2. **新しいコードに置き換え**
   - このリポジトリの`Code.gs`の内容をコピー＆ペースト

3. **Drive APIの有効化（共有ドライブを使用する場合）**
   - 手順書の「Drive APIの有効化」セクションを参照

4. **動作確認**
   - 手動実行で動作を確認
   - エラーがないか確認

5. **既存のデータ**
   - 既存のシートやデータはそのまま使用可能です
   - 新しいコードは既存のデータと互換性があります

---

## ⚠️ 注意事項

1. **Drive APIの有効化**
   - 共有ドライブのフォルダを監視する場合は、Drive APIの有効化が必須です
   - 手順書を参照して設定してください

2. **権限**
   - 共有ドライブのフォルダを監視する場合、適切なアクセス権限が必要です
   - スクリプトを実行するアカウントが共有ドライブのメンバーである必要があります

3. **実行時間**
   - 大量のファイルがある場合、処理に時間がかかる可能性があります
   - Google Apps Scriptの実行時間制限（6分）に注意してください

4. **API使用制限**
   - Drive APIには1日あたりの使用制限があります
   - 大量のフォルダを監視する場合は、実行頻度を調整してください

---

## 📚 参考資料

- [GitHubリポジトリ](https://github.com/itoksk/drive-app)
- [Google Apps Script 公式ドキュメント](https://developers.google.com/apps-script)
- [Drive API ドキュメント](https://developers.google.com/drive/api)
- [元の記事（note）](https://note.com/tyaperujp01/n/n66ac3a2dfe32)

---

**最終更新日：2026年2月3日（V2リリース）**
