# Google ドライブ フォルダ監視システム セットアップ手順書

**GitHubリポジトリ**: https://github.com/itoksk/drive-app

## 📖 目次

1. [事前準備](#事前準備)
2. [スプレッドシートの設定](#スプレッドシートの設定)
3. [Google Apps Scriptの設定](#google-apps-scriptの設定)
4. [Drive APIの有効化](#drive-apiの有効化)
5. [権限の承認](#権限の承認)
6. [フォルダ監視の設定](#フォルダ監視の設定)
7. [動作確認](#動作確認)
8. [自動実行の設定](#自動実行の設定)
9. [トラブルシューティング](#トラブルシューティング)

---

## 事前準備

### 必要なもの

- Googleアカウント
- Google ドライブへのアクセス権限
- 監視したいフォルダへのアクセス権限
- 共有ドライブを使用する場合：共有ドライブへのアクセス権限

---

## スプレッドシートの設定

### ステップ1: 新しいスプレッドシートを作成

1. [Google スプレッドシート](https://sheets.google.com)にアクセス
2. 「空白」をクリックして新しいスプレッドシートを作成
3. スプレッドシートの名前を適切な名前に変更（例：「ドライブ監視システム」）

### ステップ2: mainシートの準備

1. 最初のシートの名前を「main」に変更
   - シート名をダブルクリック → 「main」と入力

### ステップ3: ヘッダー行の設定

1. 1行目に以下のヘッダーを入力：

| A1 | B1 | C1 | D1 | E1 | F1 | G1 |
|----|----|----|----|----|----|----|
| 有効化 | フォルダURL/ID | フォルダ名 | 最終更新日時 | オーナー | メール送信先 | エラー |

2. ヘッダー行を太字にする（見やすくするため）
   - 1行目を選択 → 「B」（太字）ボタンをクリック

---

## Google Apps Scriptの設定

### ステップ1: Apps Scriptエディタを開く

1. スプレッドシートで「拡張機能」メニューをクリック
2. 「Apps Script」をクリック

### ステップ2: コードを貼り付け

1. エディタが開いたら、既存のコードをすべて削除
2. このリポジトリの`Code.gs`ファイルの内容をすべてコピー
3. エディタに貼り付け（Ctrl+V / Cmd+V）
4. 保存（Ctrl+S / Cmd+S）

### ステップ3: プロジェクト名の設定（オプション）

1. 左上の「無題のプロジェクト」をクリック
2. 適切なプロジェクト名を入力（例：「ドライブ監視システム」）

---

## Drive APIの有効化

**重要：共有ドライブのフォルダを監視する場合は必須です**

### 方法1: サービスから追加（推奨）

1. Apps Scriptエディタの左側メニューで「サービス」をクリック
2. 「+」ボタンをクリック
3. 「Drive API」を検索
4. 「Drive API」を選択して「追加」をクリック

### 方法2: コードから有効化

1. Apps Scriptエディタに以下の関数を追加：

```javascript
function enableDriveAPI() {
  try {
    Drive.Files.list({
      maxResults: 1
    });
    Logger.log('Drive APIが有効になりました');
  } catch (e) {
    Logger.log('Drive APIの有効化に失敗: ' + e.toString());
  }
}
```

2. `enableDriveAPI`関数を選択
3. 「実行」ボタンをクリック
4. 権限を承認（次のセクション参照）

---

## 権限の承認

### 初回実行時の権限承認

1. Apps Scriptエディタで`checkNewFiles`関数を選択
2. 「実行」ボタン（▶️）をクリック
3. 「承認が必要です」という画面が表示されます
4. 「権限を確認」をクリック
5. Googleアカウントを選択
6. 「詳細」をクリック
7. 「（プロジェクト名）に移動（安全ではないページ）」をクリック
8. 「許可」をクリック

### 必要な権限

- Google ドライブへのアクセス
- Google スプレッドシートへのアクセス
- メール送信（Gmail API）

---

## フォルダ監視の設定

### ステップ1: 監視したいフォルダのURLまたはIDを取得

#### 方法A: URLから取得

1. Google ドライブで監視したいフォルダを開く
2. ブラウザのアドレスバーからURLをコピー
   - 例：`https://drive.google.com/drive/folders/1ABC123...`

#### 方法B: フォルダIDのみを取得

1. URLの`/folders/`の後の文字列をコピー
   - 例：URLが`https://drive.google.com/drive/folders/1ABC123...`の場合
   - フォルダID：`1ABC123...`

### ステップ2: mainシートに入力

1. スプレッドシートに戻る
2. 2行目以降に以下の情報を入力：

| 列 | 入力内容 | 例 |
|----|---------|-----|
| A列（有効化） | `TRUE` | TRUE |
| B列（フォルダURL/ID） | フォルダのURLまたはID | `https://drive.google.com/drive/folders/1ABC...` または `1ABC...` |
| F列（メール送信先） | 通知を受け取るメールアドレス | `example@example.com` |

**注意：**
- 複数のフォルダを監視する場合は、それぞれ別の行に入力
- 監視を一時的に停止する場合は、A列を`FALSE`に変更

---

## 動作確認

### ステップ1: 手動実行

1. Apps Scriptエディタに戻る
2. `checkNewFiles`関数を選択
3. 「実行」ボタンをクリック
4. 実行ログを確認（「表示」→「ログ」）

### ステップ2: 結果の確認

1. スプレッドシートに戻る
2. 以下の点を確認：
   - C列にフォルダ名が表示されているか
   - D列に最終更新日時が表示されているか
   - E列にオーナーのメールアドレスが表示されているか
   - フォルダ名と同じ名前のシートが作成されているか
   - そのシートにファイル一覧が表示されているか

### ステップ3: エラーの確認

- G列にエラーメッセージが表示されていないか確認
- エラーがある場合は、[トラブルシューティング](#トラブルシューティング)を参照

### ステップ4: 新規ファイル追加のテスト

1. 監視対象のフォルダに新しいファイルを追加
2. Apps Scriptエディタで再度`checkNewFiles`を実行
3. メールが届くか確認
4. シートに新しいファイルが追加されているか確認

---

## 自動実行の設定

### トリガーの設定

1. Apps Scriptエディタの左側メニューで「トリガー」をクリック
2. 右下の「+ トリガーを追加」をクリック
3. 以下の設定を行う：

| 項目 | 設定値 |
|------|--------|
| 実行する関数 | `checkNewFiles` |
| 実行するデプロイ | `Head` |
| イベントのソース | `時間主導型` |
| 時間ベースのトリガー | `1時間おき`（お好みで変更可能） |

4. 「保存」をクリック
5. 必要に応じて権限を再度承認

### 実行頻度の推奨設定

- **1時間おき**: リアルタイムに近い通知が必要な場合
- **6時間おき**: 通常の業務で十分な場合
- **1日1回**: 日次でまとめて確認する場合

**注意：** 実行頻度を高くしすぎると、Google Apps Scriptの実行時間制限に達する可能性があります。

---

## トラブルシューティング

### 問題1: 「フォルダIDが無効です」というエラー

#### 原因1: URLの形式が正しくない

**対処法：**
- フォルダIDのみを直接入力してみる
- URLが完全にコピーされているか確認

#### 原因2: 共有ドライブのフォルダの場合

**対処法：**
1. Drive APIが有効になっているか確認
2. 共有ドライブへのアクセス権限があるか確認
3. スクリプトを実行するアカウントが共有ドライブのメンバーであることを確認

#### 原因3: フォルダへのアクセス権限がない

**対処法：**
- 監視したいフォルダにアクセスできるか確認
- フォルダの共有設定を確認

### 問題2: シートが作成されない

#### 原因1: シート名に使用できない文字が含まれている

**対処法：**
- プログラムが自動的に置換しますが、特殊な文字が含まれている場合は手動で確認
- フォルダ名を変更してみる

#### 原因2: シート数の上限に達している

**対処法：**
- Googleスプレッドシートのシート数上限（通常200シート）に達していないか確認
- 不要なシートを削除

#### 原因3: 権限の問題

**対処法：**
- スプレッドシートへの書き込み権限があるか確認
- スプレッドシートの所有者に確認

### 問題3: メールが送信されない

#### 原因1: メールアドレスが正しく入力されていない

**対処法：**
- F列に正しいメールアドレスが入力されているか確認
- メールアドレスの形式が正しいか確認（例：`example@example.com`）

#### 原因2: 新しいファイルが検出されていない

**対処法：**
- 既存のファイルは通知されません
- 新規追加されたファイルのみ通知されます
- 一度実行してから、新しいファイルを追加して再度実行

#### 原因3: メール送信の権限

**対処法：**
- 初回実行時にメール送信の権限を承認しているか確認
- Apps Scriptエディタで「実行」→「権限を確認」をクリック

### 問題4: 共有ドライブで動作しない

#### 原因1: Drive APIが有効になっていない

**対処法：**
1. Apps Scriptエディタで「サービス」を確認
2. 「Drive API」が追加されているか確認
3. 追加されていない場合は、[Drive APIの有効化](#drive-apiの有効化)を参照

#### 原因2: 共有ドライブへのアクセス権限

**対処法：**
- スクリプトを実行するアカウントが共有ドライブのメンバーである必要があります
- 共有ドライブの管理者にアクセス権限を依頼してください

### 問題5: 実行時間が長すぎる

#### 原因: 監視対象フォルダに大量のファイルがある

**対処法：**
- 監視対象フォルダを分割する
- 実行頻度を下げる
- 不要なファイルを削除する

### 問題6: シートが重複して作成される

#### 原因: フォルダ名に使用できない文字が含まれている／同名フォルダがある

**対処法：**
- 最新版の`Code.gs`を使用しているか確認
- 最新版では以下の仕組みで重複を防止しています：
  1. フォルダIDとシートを紐付け（シートのA1セルにフォルダIDを記録）
  2. フォルダIDとシート名のマッピングを保存
  3. 既存シートを検索して再利用
- 既に重複シートがある場合は、不要なシートを削除してください
- 削除する際は、G列にエラーが出ていないシートを残すことを推奨します

---

## よくある質問（FAQ）

### Q1: 複数のフォルダを監視できますか？

**A:** はい、可能です。mainシートの複数の行に、それぞれ異なるフォルダのURL/IDを入力してください。

### Q2: 監視を一時的に停止できますか？

**A:** はい、可能です。該当する行のA列を`FALSE`に変更してください。

### Q3: 既存のファイルも通知されますか？

**A:** いいえ、通知されません。プログラム実行後に追加された新しいファイルのみ通知されます。

### Q4: サブフォルダ内のファイルも監視されますか？

**A:** はい、監視されます。フォルダ内のすべてのサブフォルダを再帰的に監視します。

### Q5: 実行ログはどこで確認できますか？

**A:** Apps Scriptエディタで「表示」→「ログ」をクリックすると、実行ログを確認できます。

### Q6: 同じフォルダ名のフォルダを複数監視できますか？

**A:** はい、可能です。フォルダIDでシートを紐付けているため、同じフォルダ名でも別々のシートが作成されます。シート名が重複する場合は自動的に番号が付加されます（例：`フォルダ名_1`、`フォルダ名_2`）。

---

## サポート

不具合報告や質問がある場合は、以下までご連絡ください：

- [GitHubのIssues](https://github.com/itoksk/drive-app/issues)
- 元のnote記事のコメント: https://note.com/tyaperujp01/n/n66ac3a2dfe32

---

## 更新履歴

### 2026年2月3日 - 改善版リリース

- 共有ドライブ対応を追加
- URL処理の改善（複数パターン対応、フォルダIDの直接入力も可能）
- シート作成処理の改善（使用できない文字の自動置換、長さ制限への対応）
- エラーハンドリングの強化（エラーメッセージをスプレッドシートのG列に記録）
- パフォーマンス改善（バッチ書き込みによる高速化）
- シート名の重複防止（フォルダIDでシートを紐付け、既存シートを自動検出・再利用）

---

**最終更新日：2026年2月3日**
