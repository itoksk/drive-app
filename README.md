# Google ドライブ フォルダ監視・自動通知システム

Google ドライブの特定フォルダに新しいファイルやフォルダが追加された際に、自動でメール通知を送信するGoogle Apps Script（GAS）プログラムです。

**GitHubリポジトリ**: https://github.com/itoksk/drive-app

## 🆕 改善版の主な変更点

### 修正された不具合

1. **共有ドライブ対応**
   - マイドライブだけでなく、共有ドライブ（Google Workspaceの共有ドライブ）にも対応
   - Drive APIを使用したフォルダ取得処理を追加

2. **URL処理の改善**
   - 複数のURLパターンに対応（`/folders/ID`、`id=ID`、`#folders/ID`など）
   - フォルダIDを直接入力することも可能
   - URLからフォルダIDを正確に抽出

3. **シート作成処理の改善**
   - シート名に使用できない文字の自動置換
   - シート名の長さ制限（31文字）への対応
   - 同名シートが存在する場合の自動リネーム
   - フォルダIDとシート名の紐付け（重複作成の防止）

4. **エラーハンドリングの強化**
   - 詳細なエラーログ出力
   - エラー状態をスプレッドシートのG列に記録
   - 一部のファイルでエラーが発生しても処理を継続

5. **パフォーマンス改善**
   - バッチ書き込みによる処理速度向上
   - ヘッダー行の自動検出

## 📋 必要な準備

### 1. Google スプレッドシートの準備

1. 新しいGoogleスプレッドシートを作成
2. 最初のシート名を「main」に変更
3. mainシートに以下の列を設定：

| A列 | B列 | C列 | D列 | E列 | F列 | G列 |
|-----|-----|-----|-----|-----|-----|-----|
| 有効化 | フォルダURL/ID | フォルダ名 | 最終更新日時 | オーナー | メール送信先 | エラー |

### 2. Google Apps Scriptの設定

1. スプレッドシートで「拡張機能」→「Apps Script」を開く
2. このリポジトリの`Code.gs`の内容をコピー＆ペースト
3. 保存（Ctrl+S / Cmd+S）

### 3. Drive APIの有効化（共有ドライブを使用する場合）

1. Apps Scriptエディタで「サービス」→「+」をクリック
2. 「Drive API」を検索して追加
3. または、以下のコードを追加して手動で有効化：

```javascript
// 初回実行時にDrive APIを有効化するための関数
function enableDriveAPI() {
  Drive.Files.list({
    maxResults: 1
  });
}
```

### 4. 権限の承認

1. 初回実行時に「承認が必要です」という画面が表示されます
2. 「権限を確認」をクリック
3. 自分のGoogleアカウントを選択
4. 「詳細」→「（プロジェクト名）に移動（安全ではないページ）」をクリック
5. 「許可」をクリック

## 🚀 使い方

### 基本的な使い方

1. **監視したいフォルダのURLまたはフォルダIDを取得**
   - Google ドライブでフォルダを開く
   - URLバーからURLをコピー
   - または、URLの`/folders/`の後の文字列（フォルダID）をコピー

2. **mainシートに情報を入力**
   - A列：監視を有効にする場合は`TRUE`を入力
   - B列：フォルダのURLまたはフォルダIDを貼り付け
   - F列：通知を受け取るメールアドレスを入力

3. **手動実行でテスト**
   - Apps Scriptエディタで`checkNewFiles`関数を選択
   - 「実行」ボタンをクリック
   - エラーがないか確認

4. **自動実行の設定（トリガー）**
   - Apps Scriptエディタで「トリガー」をクリック
   - 「トリガーを追加」をクリック
   - 以下の設定：
     - 実行する関数: `checkNewFiles`
     - 実行するデプロイ: `Head`
     - イベントのソース: `時間主導型`
     - 時間ベースのトリガー: `1時間おき`（お好みで変更可能）

## 🔧 トラブルシューティング

### 「フォルダIDが無効です」というエラーが出る

**原因と対処法：**

1. **URLの形式が正しくない**
   - 正しいURL形式：`https://drive.google.com/drive/folders/1ABC...`
   - または、フォルダIDのみを直接入力：`1ABC...`

2. **共有ドライブのフォルダの場合**
   - Drive APIが有効になっているか確認
   - 共有ドライブへのアクセス権限があるか確認
   - スクリプトを実行するアカウントに共有ドライブへのアクセス権限が必要

3. **フォルダへのアクセス権限がない**
   - 監視したいフォルダにアクセスできるか確認
   - フォルダの共有設定を確認

### シートが作成されない

**原因と対処法：**

1. **シート名に使用できない文字が含まれている**
   - プログラムが自動的に置換しますが、特殊な文字が含まれている場合は手動で確認

2. **シート数の上限に達している**
   - Googleスプレッドシートのシート数上限（通常200シート）に達していないか確認

3. **権限の問題**
   - スプレッドシートへの書き込み権限があるか確認

### メールが送信されない

**原因と対処法：**

1. **メールアドレスが正しく入力されていない**
   - F列に正しいメールアドレスが入力されているか確認

2. **新しいファイルが検出されていない**
   - 既存のファイルは通知されません
   - 新規追加されたファイルのみ通知されます

3. **メール送信の権限**
   - 初回実行時にメール送信の権限を承認しているか確認

### 共有ドライブで動作しない

**原因と対処法：**

1. **Drive APIが有効になっていない**
   - Apps Scriptエディタで「サービス」→「Drive API」が追加されているか確認

2. **共有ドライブへのアクセス権限**
   - スクリプトを実行するアカウントが共有ドライブのメンバーである必要があります
   - 管理者に共有ドライブへのアクセス権限を依頼してください

## 📝 スプレッドシートの列説明

| 列 | 説明 | 必須 |
|----|------|------|
| A列（有効化） | `TRUE`で監視を有効化、`FALSE`または空白で無効化 | 必須 |
| B列（フォルダURL/ID） | 監視したいフォルダのURLまたはフォルダID | 必須 |
| C列（フォルダ名） | 自動で入力されます | 自動 |
| D列（最終更新日時） | 最後にチェックした日時が自動で入力されます | 自動 |
| E列（オーナー） | フォルダのオーナーのメールアドレスが自動で入力されます | 自動 |
| F列（メール送信先） | 通知を受け取るメールアドレス | 推奨 |
| G列（エラー） | エラーが発生した場合、エラーメッセージが表示されます | 自動 |

## 📧 メール通知の内容

新しいファイルやフォルダが追加されると、以下の情報がメールで通知されます：

- ファイル/フォルダ名
- URL
- 種類（ファイル/フォルダ）
- 最終更新日時
- オーナー
- フォルダ構成（パス）

## ⚠️ 注意事項

1. **実行頻度**
   - トリガーの実行頻度を高くしすぎると、Google Apps Scriptの実行時間制限に達する可能性があります
   - 推奨：1時間おき、または1日1回

2. **大量のファイル**
   - 監視対象フォルダに大量のファイルがある場合、処理に時間がかかります
   - 実行時間制限（6分）に達する可能性があります

3. **フォルダ構成の変更**
   - フォルダの階層構造が変わると、検出に影響が出る可能性があります

4. **共有ドライブの制限**
   - 共有ドライブのフォルダを監視する場合、Drive APIの使用制限に注意してください

5. **シート名の自動調整**
   - フォルダ名に使用できない文字が含まれる場合、シート名は自動的に調整されます
   - 同名フォルダがある場合は識別用のサフィックスが付くことがあります

6. **監視フォルダ数が多い場合**
   - 行数やフォルダ数が多いと実行時間・APIクォータでエラーになる可能性があります
   - トリガー頻度を下げる、対象を分割するなどで調整してください

## 📚 参考資料

- [Google Apps Script 公式ドキュメント](https://developers.google.com/apps-script)
- [Drive API ドキュメント](https://developers.google.com/drive/api)
- [元の記事（note）](https://note.com/tyaperujp01/n/n66ac3a2dfe32)

## 📄 ライセンス

このプログラムは教育目的・業務改善目的で自由に使用・改変できます。

## 🤝 貢献

不具合報告や改善提案は、[GitHubのIssues](https://github.com/itoksk/drive-app/issues)または元のnote記事のコメントでお願いします。
